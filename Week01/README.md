## 微服务概览

### 1. 微服务
    1.1 什么是微服务
        - 将巨石服务按照模块进行划分切割，构建不同的子服务，这些子服务每一个都可以独立运行，数据通过网络api交互
    1.2 微服务解决什么问题
        - 每个模块业务单一，容易维护
        - 每个服务都随意的部署，可针对的添加负载高的节点，容易扩展
        - 每个服务使用的数据库等插件都是隔离的，容灾行更好
    1.3 微服务存在什么问题
        - 服务间的引用关系错综复杂
        - 前端的调用非常复杂
        - 对基建要求较高
    1.4 如何解决
        - 引入BFF层，对各微服务的数据进行组装后，吐给前端，对前端友好，对微服务也友好
        - 人少没有高手慎用
        
### 2. 微服务结构
    2.1 架构
        - (APP) -> (API网关) -> (BFF) -> (微服务)
    2.2 各层实现功能
        - API网关: 实现与业务无关的功能 如token验证，限流等等
        - BFF: 调用各个微服务，将数据进行组装,返回给前端
        - 微服务: 具体业务
    2.3 负载均衡
        - 微服务间调用一般采用客户端负载均衡
        - 各节点在服务注册中心(ETCD)注册一个集群，客户端从注册中心拉取服务列表，并保持心跳，来确定该节点是可用的
        
### 3. 多集群
    3.1 多集群解决什么问题？
        - 针对访问量非常高的服务，需要部署多集群容灾，来提高可用性
        - 业务隔离，不同的业务调用不同的集群，如果一个集群发生故障，可以将流量切到别的集群中，提高可用性
    3.2 多集群存在什么问题？
        - 故障集群的上层业务将流量迁移到别的集群后，热点数据丢失，数据库压力大
        解决方法：多集群做负载均衡，每个上层服务都会调用到各个集群，每个集群都有热点数据
        - 上述解决方法带了新的问题：1.上层服务与所有集群的所有节点都有心跳链接(服务发现).无用功太多;2.数据更新操作缓存如何更新
        解决方法：1.每个上层服务选取集群中的部分节点维护心跳;2.订阅mysql binlog更新各集群缓存
        
### 4. 多租户
    4.1 多租户解决什么问题
        - 多测试环境部署问题
        - 线上环境压力测试（本质就是多环境）
        - 滚动更新，灰度发布
    4.2 多组分如何实现
        - grpc染色，不同的环境染成不同的颜色，服务注册的时候也要注册上，上层服务调用时带上需要的颜色(环境变量)，该颜色
        会层层传递，如果下游节点未被染色，则默认调用该未染色节点。各节点颜色不同，实现逻辑就不同，从而实现多环境(多租户)

### 5. 格言
    - 不要过早的关注性能，先标准化
    - you build it, you fix it